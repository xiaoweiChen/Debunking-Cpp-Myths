
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>9.3. å…³äºæ‹¬å· - èµ°å‡ºC++è°œäº‘</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">
  <script>
    window.MathJax = {'tex': {'inlineMath': [['$', '$'], ['\\(', '\\)']], 'displayMath': [['$$', '$$'], ['\\[', '\\]']], 'processEscapes': 'true', 'tags': 'ams'}, 'svg': {'fontCache': 'global'}};
  </script>
  
</head>

<body>
  <div class="container">
    
<div class="chapter-container">
  
<div class="navigation">
  <a href="9.2..html" class="prev-link">Â« ä¸Šä¸€ç« ï¼š9.2. é›¶çš„å®šä¹‰</a>
  <a href="9.4..html" class="next-link">ä¸‹ä¸€ç« ï¼š9.4. è¶£è°ˆ Â»</a>
</div>
<div class="back-to-toc" style="text-align:left"><a href="index.html">è¿”å›ç›®å½•</a></div>
  <section class="section"><h1 class="section-title">9.3. å…³äºæ‹¬å·</h1></section>
  <p>è¿™é‡Œï¼Œæ¥èŠèŠæœ¬ç« å·²å¤šæ¬¡æ¶‰åŠåœ†æ‹¬å·çš„è¯é¢˜ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†å±•ç¤ºæœ¬ä¹¦ä¸­å¯èƒ½æœ€é‡è¦çš„é‚£å¯¹åœ†æ‹¬å· â€”â€” è¯·çœ‹ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°ï¼š</p>
<p><pre><code class="language-cpp">static int y;

decltype(auto) number(int x) {
  return y;
}

decltype(auto) reference(int x) {
  return (y);
}</code></pre></p>
<p>è¿™ä¸¤ä¸ªå‡½æ•°çœ‹ä¼¼å‡ ä¹ç›¸åŒï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºè¿”å›å€¼å‘¨å›´é‚£å¯¹å¾®å°çš„åœ†æ‹¬å·ã€‚ä½†æ­£æ˜¯è¿™å¯¹æ‹¬å·é€ æˆäº†å¤©å£¤ä¹‹åˆ«ã€‚C++14å¼•å…¥çš„decltype(auto)æ˜¯ä¸€ä¸ªç»“åˆäº†decltypeå’Œè‡ªåŠ¨ç±»å‹æ¨å¯¼çš„ç±»å‹è¯´æ˜ç¬¦ï¼Œå®ƒæ—¢èƒ½æ ¹æ®åˆå§‹åŒ–è¡¨è¾¾å¼æ¨å¯¼ç±»å‹ï¼Œåˆèƒ½ä¿ç•™è¡¨è¾¾å¼çš„å€¼ç±»åˆ«ç‰¹æ€§(å¦‚å¼•ç”¨æˆ–éå¼•ç”¨)ã€‚ä¸autoåŸºäºå€¼ç±»åˆ«æ¨å¯¼ç±»å‹ä¸åŒï¼Œdecltype(auto)ä¼šå¿ å®ä¿ç•™åŸå§‹è¡¨è¾¾å¼çš„å€¼ç±»åˆ«ã€‚</p>
<p>ç®€è€Œè¨€ä¹‹ï¼šnumber()å‡½æ•°è¿”å›intï¼Œè€Œreference()å‡½æ•°è¿”å›int&amp;ã€‚</p>
<p>ä¸ºéªŒè¯ä¸Šè¿°ç»“è®ºï¼Œä»¥ä¸‹ä»£ç ç‰‡æ®µå¯ä½œæœ‰åŠ›ä½è¯ï¼š</p>
<p><pre><code class="language-cpp">using namespace std;
if (is_reference&lt;decltype(number(42))&gt;::value) {
  cout &lt;&lt; &quot;Reference to &quot;;
  cout &lt;&lt; typeid(typename
  remove_reference&lt;decltype(number(42))&gt;::type).name() &lt;&lt; endl;
} else {
  cout &lt;&lt; &quot;Not a reference: &quot; &lt;&lt; typeid(decltype(number(42))).name() &lt;&lt; endl;
}</code></pre></p>
<p>ä¸Šè¿°ä»£ç ç‰‡æ®µæ£€æµ‹äº†numberå‡½æ•°çš„è¿”å›ç±»å‹ã€‚æ­£å¦‚å…¶åç§°ç›´ç™½æš—ç¤ºçš„é‚£æ ·ï¼Œå®ƒè¿”å›çš„å½“ç„¶æ˜¯...ä¸€ä¸ªæ•°å­—ã€‚å½“ä½¿ç”¨MSVCç¼–è¯‘å¹¶æ‰§è¡Œæ—¶ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<p><pre><code class="language-shell">Not a reference: int</code></pre></p>
<p>å…¶ä»–ç¼–è¯‘å™¨çš„è¡Œä¸ºåŸºæœ¬ä¸€è‡´,åªä¸è¿‡å®ƒä»¬ä¸ä¼šæ‰“å°å®Œæ•´ç±»å‹åç§° â€”â€” æ¯”å¦‚gccå’Œclangå¯¹äºintç±»å‹ä»…æ˜¾ç¤ºå•ä¸ªå­—æ¯i,è¿™å°±æ²¡é‚£ä¹ˆç›´è§‚äº†ã€‚</p>
<p>æ£€éªŒä»¥ä¸‹ä»£ç :</p>
<p><pre><code class="language-cpp">if (is_reference&lt;decltype(reference(42))&gt;::value) {
  cout &lt;&lt; &quot;Reference to: &quot;;
  cout &lt;&lt; typeid(typename
  remove_reference&lt;decltype(reference(42))&gt;::type).name() &lt;&lt; endl;
} else {
  cout &lt;&lt; &quot;Not a reference: &quot; &lt;&lt; typeid(decltype(number(42))).name() &lt;&lt; endl;
}</code></pre></p>
<p>è¿™æ®µä»£ç ä¸å‰ä¾‹å‡ ä¹å®Œå…¨ç›¸åŒï¼Œåªæ˜¯æ”¹ç”¨äº†referenceæ–¹æ³•ã€‚ä¸å‡ºæ‰€æ–™ï¼Œæ‰§è¡Œç»“æœ(å†æ¬¡ä»¥MSVCä¸ºä¾‹)å¦‚ä¸‹ï¼š</p>
<p><pre><code class="language-shell">Reference to: int</code></pre></p>
<p>è‡³æ­¤æˆ‘ä»¬å·²è¯æ˜ï¼šä¸€å¯¹æ‹¬å·ä¸decltype(auto)ç»“åˆèƒ½äº§ç”ŸæƒŠäººçš„æ•ˆæœã€‚ä½†è¯·æ³¨æ„ï¼Œå¦‚æœçœç•¥decltypeï¼Œåƒä¸‹é¢è¿™æ ·ï¼š</p>
<p><pre><code class="language-cpp">auto reference(int x) {
  return (y);
}</code></pre></p>
<p>æ­¤æ—¶ç¼–è¯‘å™¨ä¼šå¿½ç•¥æ‹¬å·ï¼Œç›´æ¥è¿”å›æ™®é€šæ•°å€¼ã€‚C++æ ‡å‡†åœ¨[dcl.type.decltype]ç« èŠ‚æ˜ç¡®è§„å®šäº†è¿™ä¸€è¡Œä¸ºï¼Œç¬”è€…å¼ºçƒˆå»ºè®®é˜…è¯»è¯¥ç« èŠ‚ï¼Œä»¥é€å½»ç†è§£èƒŒåçš„åŸç†åŠå…¶åˆç†æ€§ã€‚</p>
<p>æ—¢ç„¶C++å¼€å‘è€…å§‹ç»ˆè¿½æ±‚é«˜æ•ˆã€ä¼˜è´¨å’Œæ¸…æ™°çš„ä»£ç ï¼Œæ‚¨å¯èƒ½ä¼šé—®ï¼šä¸ºä½•è¦é€šè¿‡é‡å¤ä»£ç æ¥åˆ¤æ–­è¿”å›ç±»å‹æ˜¯å¦ä¸ºå¼•ç”¨ï¼Ÿéš¾é“ä¸èƒ½ç›´æ¥å†™æˆä¸‹é¢è¿™æ ·å—ï¼Ÿ</p>
<p><pre><code class="language-cpp">template &lt;typename T&gt;
void printType(T&amp;&amp; var) {
  if (std::is_reference&lt;T&gt;::value) {
    if (std::is_lvalue_reference&lt;T&gt;::value) {
      printf(&quot;lvalue ref &quot;);
    } else {
      printf(&quot;rvalue ref &quot;);
    }
    printf(&quot;%s\n&quot;, (typeid(typename
    std::remove_reference&lt;T&gt;::type).name()));
  } else {
    printf(&quot;%s\n&quot;, typeid(var).name());
  }
}</code></pre></p>
<p>è¿™æ®µä»£ç ä¸å‰å‰æ®µ(&quot;å‰å‰æ®µ&quot;å³å½“å‰å‚ç…§ç‚¹å¾€å‰æ•°ç¬¬äºŒæ®µ)å‡ ä¹ç›¸åŒï¼Œåªæ˜¯å¢åŠ äº†éªŒè¯å¼•ç”¨ç±»å‹çš„é¢å¤–æ£€æŸ¥(åŒæ—¶å°†std::coutæ›¿æ¢ä¸ºprintfä»¥ç”Ÿæˆæ›´ç®€æ´çš„æ±‡ç¼–ä»£ç ,å¹¶å°è£…ä¸ºå‡½æ•°ä½“)ã€‚è®©æˆ‘ä»¬å°†å…¶ç½®äºä»¥ä¸‹ä¸Šä¸‹æ–‡å¹¶è°ƒç”¨:</p>
<p><pre><code class="language-cpp">printType(number(42));
printType(reference(42));</code></pre></p>
<p>å°†å¾—åˆ°ç¬¦åˆé¢„æœŸçš„æ­£ç¡®è¾“å‡ºï¼š</p>
<p><pre><code class="language-shell">int
lvalue ref int</code></pre></p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå…¶ä»–é&quot;å°å·§è½¯èŒ&quot;çš„ç¼–è¯‘å™¨ä¹Ÿèƒ½å¾—åˆ°ç›¸åŒç»“æœã€‚</p>
<p>è¯¥å‡½æ•°æ¨¡æ¿é€šè¿‡è½¬å‘å¼•ç”¨(<code>T&amp;&amp; var</code>)åŒæ—¶å¤„ç†å·¦å€¼å’Œå³å€¼å¼•ç”¨ï¼Œä»è€Œèƒ½å¤Ÿæ¨å¯¼å¹¶ä¿ç•™ä¼ å…¥å˜é‡çš„å¼•ç”¨ç±»å‹ã€‚å€ŸåŠ©ç±»å‹ç‰¹å¾åº“ï¼Œä½¿ç”¨<code>is_reference&lt;T&gt;::value</code>æ£€æŸ¥Tæ˜¯å¦ä¸ºå¼•ç”¨ç±»å‹ï¼Œå¹¶é€šè¿‡<code>is_lvalue_reference&lt;T&gt;::value</code>è¿›ä¸€æ­¥åŒºåˆ†å·¦å€¼/å³å€¼å¼•ç”¨ã€‚</p>
<p><table border="1">
  <thead>
    <tr>
      <th><strong>void printType <int>(int&&)</strong></th>
      <th><strong>void printType <int&>(int&)</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>push rbp<br> mov rbp, rsp<br> sub rsp, 16mov QWORD PTR [rbp-8], rdi<br> mov edi, OFFSET <br>                   FLAT:typeinfo <br> call std::type&#95; info::name() <br> mov rdi, rax<br> call puts <br> nop <br> leave <br> ret</td>
      <td>push rbp<br> mov rbp, rsp<br> sub rsp, 16mov QWORD PTR [rbp-8], rdi<br> mov edi, OFFSET FLAT:.LC0 <br> mov eax, 0 <br> call printf <br> mov edi, OFFSET <br>                  FLAT:typeinfo <br> call std::type&#95;info::name() <br> mov rdi, rax<br> call puts <br> nop <br> leave <br> ret <br>   .LC0:<br>     .string "lvalue ref "</td>
    </tr>
  </tbody>
</table>
</p>
<p><div style="text-align:center">
è¡¨9.1ï¼šä¸åŒprintTypeå®ä¾‹åŒ–çš„æ±‡ç¼–ä»£ç å¯¹æ¯”
</div></p>
<p>æˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ï¼Œé’ˆå¯¹ä¸¤ä¸ªå‡½æ•°è¿”å›çš„ä¸åŒç±»å‹ï¼Œç¼–è¯‘å™¨åˆ†åˆ«ç”Ÿæˆäº†printTypeå‡½æ•°çš„ä¸¤ä¸ªå®ä¾‹åŒ–ç‰ˆæœ¬ã€‚æ‰€æœ‰ç±»å‹ç‰¹å¾(type traits)çš„è°ƒç”¨éƒ½åœ¨æºä»£ç å±‚é¢å¾—åˆ°äº†å®Œç¾å®ç°ï¼Œä»è€Œæ¶ˆé™¤äº†ä¸å¿…è¦çš„æ¡ä»¶åˆ†æ”¯ã€‚æ­¤å¤–ï¼Œç¼–è¯‘å™¨è¿˜ä¼˜åŒ–ç§»é™¤äº†æœªä½¿ç”¨çš„å­—ç¬¦ä¸²(æ¯”å¦‚ç”Ÿæˆçš„æ±‡ç¼–ä»£ç ä¸­å®Œå…¨æ‰¾ä¸åˆ°&quot;rvalue ref&quot;å­—æ ·ï¼Œå› ä¸ºç¼–è¯‘å™¨å·²è¯†åˆ«å‡ºç›¸å…³åˆ†æ”¯åœ¨æœ€ç»ˆä»£ç ä¸­æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œ)ã€‚</p>
<p>è¿™éš¾é“ä¸æ˜¯C++ç²¾å¦™ä¹‹å¤„çš„ç»ä½³ä½“ç°å—ï¼Ÿ</p>
  <div class="back-to-toc" style="text-align:left"><a href="index.html">è¿”å›ç›®å½•</a></div>
<div class="navigation">
  <a href="9.2..html" class="prev-link">Â« ä¸Šä¸€ç« ï¼š9.2. é›¶çš„å®šä¹‰</a>
  <a href="9.4..html" class="next-link">ä¸‹ä¸€ç« ï¼š9.4. è¶£è°ˆ Â»</a>
</div>

</div>

  </div>
  <!-- å…ˆåŠ è½½æ ¸å¿ƒåº“ -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  
  <!-- åŠ è½½MathJax -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" id="MathJax-script" async></script>
  
  <!-- ä¸»é¢˜åˆ‡æ¢è„šæœ¬ -->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // åˆ›å»ºä¸»é¢˜åˆ‡æ¢æŒ‰é’®
    const themeToggle = document.createElement('button');
    themeToggle.className = 'theme-toggle';
    themeToggle.setAttribute('aria-label', 'åˆ‡æ¢ä¸»é¢˜');
    themeToggle.innerHTML = 'ğŸŒ“';
    document.body.appendChild(themeToggle);
    
    // æ·»åŠ æ·±è‰²å’Œæµ…è‰²ä¸»é¢˜çš„æ ·å¼
    const darkThemeStyle = document.createElement('style');
    const lightThemeStyle = document.createElement('style');
    
    darkThemeStyle.textContent = `
      body.dark-theme {
        --background-color: #1a1a1a;
        --text-color: #e6e6e6;
        --code-bg-color: #2d2d2d;
        --link-color: #58a6ff;
        --highlight-color: #58a6ff;
        --border-color: #333;
        --table-border-color: #444;
        --table-header-bg: #2d2d2d;
        --blockquote-color: #aaa;
        --blockquote-border: #444;
        --part-header-bg: #222;
        --footer-text-color: #aaa;
        --filename-bg: #2d2d2d;
        --nav-bg: #2d2d2d;
        --nav-hover-bg: #444;
        --toc-bg: #222;
        --highlight-section-bg: #2d2d2d;
        --highlight-section-border: #58a6ff;
      }
    `;
    
    lightThemeStyle.textContent = `
      body.light-theme {
        --background-color: #ffffff;
        --text-color: #333333;
        --code-bg-color: #f5f5f5;
        --link-color: #0366d6;
        --highlight-color: #0366d6;
        --border-color: #eee;
        --table-border-color: #ddd;
        --table-header-bg: #f2f2f2;
        --blockquote-color: #666;
        --blockquote-border: #ddd;
        --part-header-bg: #f8f8f8;
        --footer-text-color: #666;
        --filename-bg: #f5f5f5;
        --nav-bg: #f5f5f5;
        --nav-hover-bg: #e6e6e6;
        --toc-bg: #f8f8f8;
        --highlight-section-bg: #f8f8f8;
        --highlight-section-border: #0366d6;
      }
    `;
    
    document.head.appendChild(darkThemeStyle);
    document.head.appendChild(lightThemeStyle);
    
    // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­çš„è®¾ç½®
    const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    const currentTheme = localStorage.getItem('theme');
    
    if (currentTheme === 'dark') {
      document.body.classList.add('dark-theme');
    } else if (currentTheme === 'light') {
      document.body.classList.add('light-theme');
    } else {
      // å¦‚æœæ²¡æœ‰ä¿å­˜çš„åå¥½ï¼Œè·Ÿéšç³»ç»Ÿ
      if (prefersDarkScheme.matches) {
        document.body.classList.add('dark-theme');
      } else {
        document.body.classList.add('light-theme');
      }
    }
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    themeToggle.addEventListener('click', function() {
      console.log('Theme toggle clicked');
      if (document.body.classList.contains('dark-theme')) {
        document.body.classList.remove('dark-theme');
        document.body.classList.add('light-theme');
        localStorage.setItem('theme', 'light');
      } else {
        document.body.classList.remove('light-theme');
        document.body.classList.add('dark-theme');
        localStorage.setItem('theme', 'dark');
      }
    });
    
    // ç¡®ä¿ä»£ç å—æœ‰æ­£ç¡®çš„ç±»å
    document.querySelectorAll('pre code').forEach(function(block) {
      if (!block.className && block.parentNode.innerHTML.includes('cpp')) {
        block.className = 'language-cpp';
      } else if (!block.className && block.parentNode.innerHTML.includes('rust')) {
        block.className = 'language-rust';
      } else if (!block.className) {
        block.className = 'language-plaintext';
      }
    });
    
    // å»¶è¿ŸåŠ è½½Prismé«˜äº®
    setTimeout(function() {
      if (window.Prism) {
        window.Prism.highlightAll();
      }
    }, 500);
  });
  </script>
</body>
</html>